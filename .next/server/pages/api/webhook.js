"use strict";(()=>{var a={};a.id=954,a.ids=[954],a.modules={73:a=>{a.exports=require("@line/bot-sdk")},1428:a=>{a.exports=import("axios")},3253:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{E:()=>j});var e=c(73),f=c(1428),g=a([f]);f=(g.then?(await g)():g)[0];let h={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN,channelSecret:process.env.LINE_CHANNEL_SECRET},i=new e.Client(h),j={replyMessage:async(a,b)=>await i.replyMessage(a,{type:"text",text:b}),pushMessage:async(a,b)=>await i.pushMessage(a,{type:"text",text:b}),async downloadImage(a){try{let b=await (0,f.default)({method:"get",url:`https://api-data.line.me/v2/bot/message/${a}/content`,headers:{Authorization:`Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`},responseType:"arraybuffer"});return Buffer.from(b.data)}catch(a){throw console.error("Error downloading image:",a),a}},createSummaryMessage:a=>({type:"flex",altText:"à¸ªà¸£à¸¸à¸›à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢",contents:{type:"bubble",header:{type:"box",layout:"vertical",contents:[{type:"text",text:"à¸ªà¸£à¸¸à¸›à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢",weight:"bold",size:"xl",color:"#ffffff"}],backgroundColor:"#27ACB2",paddingAll:"20px"},body:{type:"box",layout:"vertical",contents:[{type:"text",text:`à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${a.date}`,size:"md",color:"#555555"},{type:"text",text:`à¸ˆà¸³à¸™à¸§à¸™à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ: ${a.receiptCount} à¹ƒà¸š`,size:"md",color:"#555555"},{type:"text",text:`à¸¢à¸­à¸”à¸£à¸§à¸¡: ${a.totalAmount.toLocaleString()} à¸šà¸²à¸—`,size:"lg",weight:"bold",color:"#27ACB2"}],spacing:"md"}}})};d()}catch(a){d(a)}})},4016:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(8442),j=c(8112),k=c(8766),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/webhook",pathname:"/api/webhook",bundlePath:"",filename:""},userland:i,distDir:".next",projectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/webhook"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),i=p.instrumentationOnRequestError.bind(p),l=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/webhook",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await l(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},l))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7384:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{L:()=>h});var e=c(9946),f=a([e]);let g=new(e=(f.then?(await f)():f)[0]).default({apiKey:process.env.GROQ_API_KEY}),h={async analyzeReceipt(a){try{let b=`
        à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¹ƒà¸™à¸£à¸¹à¸›à¸ à¸²à¸žà¸™à¸µà¹‰ à¹à¸¥à¸°à¹à¸¢à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸­à¸à¸¡à¸²à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š JSON:
        
        {
          "total_amount": à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸£à¸§à¸¡ (à¸•à¸±à¸§à¹€à¸¥à¸‚à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™),
          "date": "à¸§à¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š YYYY-MM-DD",
          "store_name": "à¸Šà¸·à¹ˆà¸­à¸£à¹‰à¸²à¸™",
          "items": [
            {
              "name": "à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²",
              "price": à¸£à¸²à¸„à¸² (à¸•à¸±à¸§à¹€à¸¥à¸‚à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™),
              "quantity": à¸ˆà¸³à¸™à¸§à¸™,
              "category": "à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆà¸ªà¸´à¸™à¸„à¹‰à¸² à¹€à¸Šà¹ˆà¸™ à¸­à¸²à¸«à¸²à¸£, à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸”à¸·à¹ˆà¸¡, à¸‚à¸­à¸‡à¹ƒà¸Šà¹‰"
            }
          ]
        }
        
        à¸«à¸²à¸à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸Šà¸±à¸” à¹ƒà¸«à¹‰à¹ƒà¸ªà¹ˆ null
        à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸­à¸·à¹ˆà¸™
      `,c=await g.chat.completions.create({messages:[{role:"user",content:[{type:"text",text:b},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${a}`}}]}],model:"llava-v1.5-7b-4096-preview",temperature:.1,max_tokens:1e3}),d=c.choices[0]?.message?.content;try{return JSON.parse(d)}catch(a){throw console.error("JSON parse error:",a),Error("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹à¸›à¸¥à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹€à¸›à¹‡à¸™ JSON à¹„à¸”à¹‰")}}catch(a){throw console.error("Groq API error:",a),Error("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ")}},async generateDailySummary(a){let b=`
      à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸¸à¸›à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸™à¸µà¹‰:
      ${JSON.stringify(a,null,2)}
      
      à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸£à¸¸à¸›à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ à¸£à¸§à¸¡à¸–à¸¶à¸‡:
      - à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
      - à¸ˆà¸³à¸™à¸§à¸™à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ
      - à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆà¸—à¸µà¹ˆà¸‹à¸·à¹‰à¸­à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”
      - à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸ªà¸±à¸‡à¹€à¸à¸•
    `,c=await g.chat.completions.create({messages:[{role:"user",content:b}],model:"mixtral-8x7b-32768",temperature:.7,max_tokens:500});return c.choices[0]?.message?.content}};d()}catch(a){d(a)}})},8442:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>k});var e=c(3253),f=c(7384),g=c(9964),h=c(5511),i=c.n(h),j=a([e,f]);async function k(a,b){if("POST"!==a.method)return b.status(405).json({message:"Method not allowed"});let c=a.headers["x-line-signature"],d=JSON.stringify(a.body),e=i().createHmac("sha256",process.env.LINE_CHANNEL_SECRET).update(d).digest("base64");if(c!==e)return b.status(401).json({message:"Invalid signature"});try{for(let b of a.body.events)await l(b);b.status(200).json({message:"OK"})}catch(a){console.error("Webhook error:",a),b.status(500).json({error:a.message})}}async function l(a){let{type:b,replyToken:c,source:d,message:f}=a,g=d.userId;try{"message"===b&&("image"===f.type?await m(c,g,f.id):"text"===f.type&&await n(c,g,f.text))}catch(a){console.error("Event handling error:",a),await e.E.replyMessage(c,"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡")}}async function m(a,b,c){try{var d;let h;await e.E.replyMessage(a,"à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ...");let i=await e.E.downloadImage(c),j=i.toString("base64"),k=`${b}_${Date.now()}.jpg`,l=await g.k.uploadImage(i,k),m=await f.L.analyzeReceipt(j),n=await g.k.saveReceipt(b,l,m.total_amount,m.date||new Date().toISOString().split("T")[0]);m.items&&m.items.length>0&&await g.k.saveItems(n.id,m.items);let o=(d=m,h=`âœ… à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§!

`,d.store_name&&(h+=`ðŸª à¸£à¹‰à¸²à¸™: ${d.store_name}
`),d.date&&(h+=`ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${d.date}
`),h+=`ðŸ’° à¸¢à¸­à¸”à¸£à¸§à¸¡: ${d.total_amount?.toLocaleString()||"à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸"} à¸šà¸²à¸—

`,d.items&&d.items.length>0&&(h+=`ðŸ“ à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²:
`,d.items.forEach(a=>{h+=`â€¢ ${a.name} - ${a.price?.toLocaleString()} à¸šà¸²à¸—
`})),h+=`
ðŸ’¡ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§ à¸žà¸´à¸¡à¸žà¹Œ "à¸ªà¸£à¸¸à¸›" à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸ªà¸£à¸¸à¸›à¸§à¸±à¸™à¸™à¸µà¹‰`);await e.E.pushMessage(b,o)}catch(a){console.error("Image processing error:",a),await e.E.pushMessage(b,"à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸«à¹‰à¸Šà¸±à¸”à¸‚à¸¶à¹‰à¸™")}}async function n(a,b,c){let d=c.toLowerCase().trim();if(d.includes("à¸ªà¸£à¸¸à¸›")||d.includes("summary")){let c=new Date().toISOString().split("T")[0],d=await g.k.getDailySummary(b,c);if(0===d.length)return void await e.E.replyMessage(a,"à¸§à¸±à¸™à¸™à¸µà¹‰à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ");let f=function(a){let b=a.reduce((a,b)=>a+parseFloat(b.total_amount||0),0);return{date:new Date().toLocaleDateString("th-TH"),receiptCount:a.length,totalAmount:b}}(d),h=e.E.createSummaryMessage(f);await e.E.replyMessage(a,h)}else if(d.includes("à¹€à¸”à¸·à¸­à¸™")||d.includes("month")){let c=new Date,d=await g.k.getMonthlySummary(b,c.getFullYear(),c.getMonth()+1);if(0===d.length)return void await e.E.replyMessage(a,"à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ");let f=function(a){let b=a.reduce((a,b)=>a+parseFloat(b.total_amount||0),0),c=a.reduce((a,b)=>a+(b.items?.length||0),0);return`ðŸ“Š à¸ªà¸£à¸¸à¸›à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰

ðŸ’° à¸¢à¸­à¸”à¸£à¸§à¸¡: ${b.toLocaleString()} à¸šà¸²à¸—
ðŸ“‹ à¸ˆà¸³à¸™à¸§à¸™à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ: ${a.length} à¹ƒà¸š
ðŸ›ï¸ à¸ˆà¸³à¸™à¸§à¸™à¸£à¸²à¸¢à¸à¸²à¸£: ${c} à¸£à¸²à¸¢à¸à¸²à¸£`}(d);await e.E.replyMessage(a,f)}else await e.E.replyMessage(a,'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! \uD83D\uDCF1\n\nà¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸¡à¸²à¹ƒà¸«à¹‰à¸œà¸¡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹„à¸”à¹‰à¹€à¸¥à¸¢\n\nà¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œ:\nâ€¢ "à¸ªà¸£à¸¸à¸›" - à¸”à¸¹à¸ªà¸£à¸¸à¸›à¸§à¸±à¸™à¸™à¸µà¹‰\nâ€¢ "à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸£à¸¸à¸›à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰')}[e,f]=j.then?(await j)():j,d()}catch(a){d(a)}})},9946:a=>{a.exports=import("groq-sdk")},9964:(a,b,c)=>{c.d(b,{k:()=>e});let d=(0,require("@supabase/supabase-js").createClient)("https://jlmoowrkijaqyaxqfbpb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbW9vd3JraWphcXlheHFmYnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzkyMTIsImV4cCI6MjA2OTYxNTIxMn0.yIWG2eS96ouYzCLMd7oGJkiZUpzmzrHp_-6l2PIIRKY"),e={async saveReceipt(a,b,c,e){let{data:f,error:g}=await d.from("receipts").insert([{user_id:a,image_url:b,total_amount:c,receipt_date:e}]).select().single();if(g)throw g;return f},async saveItems(a,b){let c=b.map(b=>({receipt_id:a,item_name:b.name,price:b.price,quantity:b.quantity||1,category:b.category||"à¸­à¸·à¹ˆà¸™à¹†"})),{data:e,error:f}=await d.from("items").insert(c).select();if(f)throw f;return e},async getDailySummary(a,b){let{data:c,error:e}=await d.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",a).gte("created_at",`${b}T00:00:00`).lt("created_at",`${b}T23:59:59`);if(e)throw e;return c},async getMonthlySummary(a,b,c){let e=`${b}-${c.toString().padStart(2,"0")}-01`,f=new Date(b,c,0).toISOString().split("T")[0],{data:g,error:h}=await d.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",a).gte("receipt_date",e).lte("receipt_date",f);if(h)throw h;return g},async uploadImage(a,b){let{data:c,error:e}=await d.storage.from("receipt-images").upload(b,a);if(e)throw e;let{data:{publicUrl:f}}=d.storage.from("receipt-images").getPublicUrl(b);return f}}}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=4016));module.exports=c})();