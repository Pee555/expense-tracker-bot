"use strict";(()=>{var a={};a.id=954,a.ids=[954],a.modules={73:a=>{a.exports=require("@line/bot-sdk")},1428:a=>{a.exports=import("axios")},3253:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{E:()=>j});var e=c(73),f=c(1428),g=a([f]);f=(g.then?(await g)():g)[0];let h={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN,channelSecret:process.env.LINE_CHANNEL_SECRET},i=new e.Client(h),j={replyMessage:async(a,b)=>await i.replyMessage(a,{type:"text",text:b}),pushMessage:async(a,b)=>await i.pushMessage(a,{type:"text",text:b}),async downloadImage(a){try{let b=await (0,f.default)({method:"get",url:`https://api-data.line.me/v2/bot/message/${a}/content`,headers:{Authorization:`Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`},responseType:"arraybuffer"});return Buffer.from(b.data)}catch(a){throw console.error("Error downloading image:",a),a}},createSummaryMessage:a=>({type:"flex",altText:"р╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в",contents:{type:"bubble",header:{type:"box",layout:"vertical",contents:[{type:"text",text:"р╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в",weight:"bold",size:"xl",color:"#ffffff"}],backgroundColor:"#27ACB2",paddingAll:"20px"},body:{type:"box",layout:"vertical",contents:[{type:"text",text:`р╕зр╕▒р╕Щр╕Чр╕╡р╣И: ${a.date}`,size:"md",color:"#555555"},{type:"text",text:`р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И: ${a.receiptCount} р╣Гр╕Ъ`,size:"md",color:"#555555"},{type:"text",text:`р╕вр╕нр╕Фр╕гр╕зр╕б: ${a.totalAmount.toLocaleString()} р╕Ър╕▓р╕Ч`,size:"lg",weight:"bold",color:"#27ACB2"}],spacing:"md"}}})};d()}catch(a){d(a)}})},4016:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(8442),j=c(8112),k=c(8766),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/webhook",pathname:"/api/webhook",bundlePath:"",filename:""},userland:i,distDir:".next",projectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/webhook"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),i=p.instrumentationOnRequestError.bind(p),l=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/webhook",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await l(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},l))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7384:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{L:()=>h});var e=c(9946),f=a([e]);let g=new(e=(f.then?(await f)():f)[0]).default({apiKey:process.env.GROQ_API_KEY}),h={async analyzeReceipt(a){try{let b=`
        р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Гр╕Щр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Щр╕╡р╣Й р╣Бр╕ер╕░р╣Бр╕вр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕нр╕Бр╕бр╕▓р╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ JSON:
        
        {
          "total_amount": р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щр╕гр╕зр╕б (р╕Хр╕▒р╕зр╣Ар╕ер╕Вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ),
          "date": "р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ YYYY-MM-DD",
          "store_name": "р╕Кр╕╖р╣Ир╕нр╕гр╣Йр╕▓р╕Щ",
          "items": [
            {
              "name": "р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓",
              "price": р╕гр╕▓р╕Др╕▓ (р╕Хр╕▒р╕зр╣Ар╕ер╕Вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ),
              "quantity": р╕Ир╕│р╕Щр╕зр╕Щ,
              "category": "р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╣Ар╕Кр╣Ир╕Щ р╕нр╕▓р╕лр╕▓р╕г, р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Фр╕╖р╣Ир╕б, р╕Вр╕нр╕Зр╣Гр╕Кр╣Й"
            }
          ]
        }
        
        р╕лр╕▓р╕Бр╕нр╣Ир╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Кр╕▒р╕Ф р╣Гр╕лр╣Йр╣Гр╕кр╣И null
        р╕Хр╕нр╕Ър╣Ар╕Ыр╣Зр╕Щ JSON р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕вр╕нр╕╖р╣Ир╕Щ
      `,c=await g.chat.completions.create({messages:[{role:"user",content:[{type:"text",text:b},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${a}`}}]}],model:"llava-v1.5-7b-4096-preview",temperature:.1,max_tokens:1e3}),d=c.choices[0]?.message?.content;try{return JSON.parse(d)}catch(a){throw console.error("JSON parse error:",a),Error("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Ыр╕ер╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Ар╕Ыр╣Зр╕Щ JSON р╣Др╕Фр╣Й")}}catch(a){throw console.error("Groq API error:",a),Error("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И")}},async generateDailySummary(a){let b=`
      р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕Щр╕╡р╣Й:
      ${JSON.stringify(a,null,2)}
      
      р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕кр╕гр╕╕р╕Ыр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕гр╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Зр╣Ир╕▓р╕в р╕гр╕зр╕бр╕Цр╕╢р╕З:
      - р╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
      - р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И
      - р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Чр╕╡р╣Ир╕Лр╕╖р╣Йр╕нр╕бр╕▓р╕Бр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф
      - р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕лр╕гр╕╖р╕нр╕Вр╣Йр╕нр╕кр╕▒р╕Зр╣Ар╕Бр╕Х
    `,c=await g.chat.completions.create({messages:[{role:"user",content:b}],model:"mixtral-8x7b-32768",temperature:.7,max_tokens:500});return c.choices[0]?.message?.content}};d()}catch(a){d(a)}})},8442:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>k});var e=c(3253),f=c(7384),g=c(9964),h=c(5511),i=c.n(h),j=a([e,f]);async function k(a,b){if("POST"!==a.method)return b.status(405).json({message:"Method not allowed"});let c=a.headers["x-line-signature"],d=JSON.stringify(a.body),e=i().createHmac("sha256",process.env.LINE_CHANNEL_SECRET).update(d).digest("base64");if(c!==e)return b.status(401).json({message:"Invalid signature"});try{for(let b of a.body.events)await l(b);b.status(200).json({message:"OK"})}catch(a){console.error("Webhook error:",a),b.status(500).json({error:a.message})}}async function l(a){let{type:b,replyToken:c,source:d,message:f}=a,g=d.userId;try{"message"===b&&("image"===f.type?await m(c,g,f.id):"text"===f.type&&await n(c,g,f.text))}catch(a){console.error("Event handling error:",a),await e.E.replyMessage(c,"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")}}async function m(a,b,c){try{var d;let h;await e.E.replyMessage(a,"р╕Бр╕│р╕ер╕▒р╕Зр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕нр╕кр╕▒р╕Бр╕Др╕гр╕╣р╣И...");let i=await e.E.downloadImage(c),j=i.toString("base64"),k=`${b}_${Date.now()}.jpg`,l=await g.k.uploadImage(i,k),m=await f.L.analyzeReceipt(j),n=await g.k.saveReceipt(b,l,m.total_amount,m.date||new Date().toISOString().split("T")[0]);m.items&&m.items.length>0&&await g.k.saveItems(n.id,m.items);let o=(d=m,h=`тЬЕ р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з!

`,d.store_name&&(h+=`ЁЯПк р╕гр╣Йр╕▓р╕Щ: ${d.store_name}
`),d.date&&(h+=`ЁЯУЕ р╕зр╕▒р╕Щр╕Чр╕╡р╣И: ${d.date}
`),h+=`ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: ${d.total_amount?.toLocaleString()||"р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕"} р╕Ър╕▓р╕Ч

`,d.items&&d.items.length>0&&(h+=`ЁЯУЭ р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕┤р╕Щр╕Др╣Йр╕▓:
`,d.items.forEach(a=>{h+=`тАв ${a.name} - ${a.price?.toLocaleString()} р╕Ър╕▓р╕Ч
`})),h+=`
ЁЯТб р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Бр╕ер╣Йр╕з р╕Юр╕┤р╕бр╕Юр╣М "р╕кр╕гр╕╕р╕Ы" р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╕зр╕▒р╕Щр╕Щр╕╡р╣Й`);await e.E.pushMessage(b,o)}catch(a){console.error("Image processing error:",a),await e.E.pushMessage(b,"р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Др╕Фр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Йр╕Кр╕▒р╕Фр╕Вр╕╢р╣Йр╕Щ")}}async function n(a,b,c){let d=c.toLowerCase().trim();if(d.includes("р╕кр╕гр╕╕р╕Ы")||d.includes("summary")){let c=new Date().toISOString().split("T")[0],d=await g.k.getDailySummary(b,c);if(0===d.length)return void await e.E.replyMessage(a,"р╕зр╕▒р╕Щр╕Щр╕╡р╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И");let f=function(a){let b=a.reduce((a,b)=>a+parseFloat(b.total_amount||0),0);return{date:new Date().toLocaleDateString("th-TH"),receiptCount:a.length,totalAmount:b}}(d),h=e.E.createSummaryMessage(f);await e.E.replyMessage(a,h)}else if(d.includes("р╣Ар╕Фр╕╖р╕нр╕Щ")||d.includes("month")){let c=new Date,d=await g.k.getMonthlySummary(b,c.getFullYear(),c.getMonth()+1);if(0===d.length)return void await e.E.replyMessage(a,"р╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И");let f=function(a){let b=a.reduce((a,b)=>a+parseFloat(b.total_amount||0),0),c=a.reduce((a,b)=>a+(b.items?.length||0),0);return`ЁЯУК р╕кр╕гр╕╕р╕Ыр╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й

ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: ${b.toLocaleString()} р╕Ър╕▓р╕Ч
ЁЯУЛ р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И: ${a.length} р╣Гр╕Ъ
ЁЯЫНя╕П р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г: ${c} р╕гр╕▓р╕вр╕Бр╕▓р╕г`}(d);await e.E.replyMessage(a,f)}else await e.E.replyMessage(a,'р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╕гр╕▒р╕Ъ! \uD83D\uDCF1\n\nр╕кр╣Ир╕Зр╕гр╕╣р╕Ыр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕бр╕▓р╣Гр╕лр╣Йр╕Ьр╕бр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Др╕Фр╣Йр╣Ар╕ер╕в\n\nр╕лр╕гр╕╖р╕нр╕Юр╕┤р╕бр╕Юр╣М:\nтАв "р╕кр╕гр╕╕р╕Ы" - р╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╕зр╕▒р╕Щр╕Щр╕╡р╣Й\nтАв "р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й')}[e,f]=j.then?(await j)():j,d()}catch(a){d(a)}})},9946:a=>{a.exports=import("groq-sdk")},9964:(a,b,c)=>{c.d(b,{k:()=>e});let d=(0,require("@supabase/supabase-js").createClient)("https://jlmoowrkijaqyaxqfbpb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbW9vd3JraWphcXlheHFmYnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzkyMTIsImV4cCI6MjA2OTYxNTIxMn0.yIWG2eS96ouYzCLMd7oGJkiZUpzmzrHp_-6l2PIIRKY"),e={async saveReceipt(a,b,c,e){let{data:f,error:g}=await d.from("receipts").insert([{user_id:a,image_url:b,total_amount:c,receipt_date:e}]).select().single();if(g)throw g;return f},async saveItems(a,b){let c=b.map(b=>({receipt_id:a,item_name:b.name,price:b.price,quantity:b.quantity||1,category:b.category||"р╕нр╕╖р╣Ир╕Щр╣Ж"})),{data:e,error:f}=await d.from("items").insert(c).select();if(f)throw f;return e},async getDailySummary(a,b){let{data:c,error:e}=await d.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",a).gte("created_at",`${b}T00:00:00`).lt("created_at",`${b}T23:59:59`);if(e)throw e;return c},async getMonthlySummary(a,b,c){let e=`${b}-${c.toString().padStart(2,"0")}-01`,f=new Date(b,c,0).toISOString().split("T")[0],{data:g,error:h}=await d.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",a).gte("receipt_date",e).lte("receipt_date",f);if(h)throw h;return g},async uploadImage(a,b){let{data:c,error:e}=await d.storage.from("receipt-images").upload(b,a);if(e)throw e;let{data:{publicUrl:f}}=d.storage.from("receipt-images").getPublicUrl(b);return f}}}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=4016));module.exports=c})();