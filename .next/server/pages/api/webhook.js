"use strict";(()=>{var e={};e.id=538,e.ids=[538],e.modules={2261:e=>{e.exports=require("@line/bot-sdk")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},9648:e=>{e.exports=import("axios")},6219:e=>{e.exports=import("groq-sdk")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},525:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>c,routeModule:()=>p});var s=a(1802),n=a(7153),o=a(6249),i=a(9753),l=e([i]);i=(l.then?(await l)():l)[0];let c=(0,o.l)(i,"default"),u=(0,o.l)(i,"config"),p=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/webhook",pathname:"/api/webhook",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},6884:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{c:()=>i});var s=a(6219),n=e([s]);let o=new(s=(n.then?(await n)():n)[0]).default({apiKey:process.env.GROQ_API_KEY}),i={async analyzeReceipt(e){try{let t=`
        р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Гр╕Щр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Щр╕╡р╣Й р╣Бр╕ер╕░р╣Бр╕вр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕нр╕Бр╕бр╕▓р╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ JSON:
        
        {
          "total_amount": р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щр╕гр╕зр╕б (р╕Хр╕▒р╕зр╣Ар╕ер╕Вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ),
          "date": "р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ YYYY-MM-DD",
          "store_name": "р╕Кр╕╖р╣Ир╕нр╕гр╣Йр╕▓р╕Щ",
          "items": [
            {
              "name": "р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓",
              "price": р╕гр╕▓р╕Др╕▓ (р╕Хр╕▒р╕зр╣Ар╕ер╕Вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ),
              "quantity": р╕Ир╕│р╕Щр╕зр╕Щ,
              "category": "р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╣Ар╕Кр╣Ир╕Щ р╕нр╕▓р╕лр╕▓р╕г, р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Фр╕╖р╣Ир╕б, р╕Вр╕нр╕Зр╣Гр╕Кр╣Й"
            }
          ]
        }
        
        р╕лр╕▓р╕Бр╕нр╣Ир╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Кр╕▒р╕Ф р╣Гр╕лр╣Йр╣Гр╕кр╣И null
        р╕Хр╕нр╕Ър╣Ар╕Ыр╣Зр╕Щ JSON р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕вр╕нр╕╖р╣Ир╕Щ
      `,a=await o.chat.completions.create({messages:[{role:"user",content:[{type:"text",text:t},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${e}`}}]}],model:"llava-v1.5-7b-4096-preview",temperature:.1,max_tokens:1e3}),r=a.choices[0]?.message?.content;try{return JSON.parse(r)}catch(e){throw console.error("JSON parse error:",e),Error("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Ыр╕ер╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Ар╕Ыр╣Зр╕Щ JSON р╣Др╕Фр╣Й")}}catch(e){throw console.error("Groq API error:",e),Error("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И")}},async generateDailySummary(e){let t=`
      р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕Щр╕╡р╣Й:
      ${JSON.stringify(e,null,2)}
      
      р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕кр╕гр╕╕р╕Ыр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕гр╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Зр╣Ир╕▓р╕в р╕гр╕зр╕бр╕Цр╕╢р╕З:
      - р╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
      - р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И
      - р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Чр╕╡р╣Ир╕Лр╕╖р╣Йр╕нр╕бр╕▓р╕Бр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф
      - р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕лр╕гр╕╖р╕нр╕Вр╣Йр╕нр╕кр╕▒р╕Зр╣Ар╕Бр╕Х
    `,a=await o.chat.completions.create({messages:[{role:"user",content:t}],model:"mixtral-8x7b-32768",temperature:.7,max_tokens:500});return a.choices[0]?.message?.content}};r()}catch(e){r(e)}})},7553:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{f:()=>c});var s=a(2261),n=a(9648),o=e([n]);n=(o.then?(await o)():o)[0];let i={channelAccessToken:process.env.LINE_CHANNEL_ACCESS_TOKEN,channelSecret:process.env.LINE_CHANNEL_SECRET},l=new s.Client(i),c={replyMessage:async(e,t)=>await l.replyMessage(e,{type:"text",text:t}),pushMessage:async(e,t)=>await l.pushMessage(e,{type:"text",text:t}),async downloadImage(e){try{let t=await (0,n.default)({method:"get",url:`https://api-data.line.me/v2/bot/message/${e}/content`,headers:{Authorization:`Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`},responseType:"arraybuffer"});return Buffer.from(t.data)}catch(e){throw console.error("Error downloading image:",e),e}},createSummaryMessage:e=>({type:"flex",altText:"р╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в",contents:{type:"bubble",header:{type:"box",layout:"vertical",contents:[{type:"text",text:"р╕кр╕гр╕╕р╕Ыр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в",weight:"bold",size:"xl",color:"#ffffff"}],backgroundColor:"#27ACB2",paddingAll:"20px"},body:{type:"box",layout:"vertical",contents:[{type:"text",text:`р╕зр╕▒р╕Щр╕Чр╕╡р╣И: ${e.date}`,size:"md",color:"#555555"},{type:"text",text:`р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И: ${e.receiptCount} р╣Гр╕Ъ`,size:"md",color:"#555555"},{type:"text",text:`р╕вр╕нр╕Фр╕гр╕зр╕б: ${e.totalAmount.toLocaleString()} р╕Ър╕▓р╕Ч`,size:"lg",weight:"bold",color:"#27ACB2"}],spacing:"md"}}})};r()}catch(e){r(e)}})},395:(e,t,a)=>{a.d(t,{T:()=>s});let r=(0,require("@supabase/supabase-js").createClient)("https://jlmoowrkijaqyaxqfbpb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbW9vd3JraWphcXlheHFmYnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzkyMTIsImV4cCI6MjA2OTYxNTIxMn0.yIWG2eS96ouYzCLMd7oGJkiZUpzmzrHp_-6l2PIIRKY"),s={async saveReceipt(e,t,a,s){let{data:n,error:o}=await r.from("receipts").insert([{user_id:e,image_url:t,total_amount:a,receipt_date:s}]).select().single();if(o)throw o;return n},async saveItems(e,t){let a=t.map(t=>({receipt_id:e,item_name:t.name,price:t.price,quantity:t.quantity||1,category:t.category||"р╕нр╕╖р╣Ир╕Щр╣Ж"})),{data:s,error:n}=await r.from("items").insert(a).select();if(n)throw n;return s},async getDailySummary(e,t){let{data:a,error:s}=await r.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",e).gte("created_at",`${t}T00:00:00`).lt("created_at",`${t}T23:59:59`);if(s)throw s;return a},async getMonthlySummary(e,t,a){let s=`${t}-${a.toString().padStart(2,"0")}-01`,n=new Date(t,a,0).toISOString().split("T")[0],{data:o,error:i}=await r.from("receipts").select(`
        *,
        items (*)
      `).eq("user_id",e).gte("receipt_date",s).lte("receipt_date",n);if(i)throw i;return o},async uploadImage(e,t){let{data:a,error:s}=await r.storage.from("receipt-images").upload(t,e);if(s)throw s;let{data:{publicUrl:n}}=r.storage.from("receipt-images").getPublicUrl(t);return n}}},9753:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>u});var s=a(7553),n=a(6884),o=a(395),i=a(4770),l=a.n(i),c=e([s,n]);async function u(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});let a=e.headers["x-line-signature"],r=JSON.stringify(e.body),s=l().createHmac("sha256",process.env.LINE_CHANNEL_SECRET).update(r).digest("base64");if(a!==s)return t.status(401).json({message:"Invalid signature"});try{for(let t of e.body.events)await p(t);t.status(200).json({message:"OK"})}catch(e){console.error("Webhook error:",e),t.status(500).json({error:e.message})}}async function p(e){let{type:t,replyToken:a,source:r,message:n}=e,o=r.userId;try{"message"===t&&("image"===n.type?await m(a,o,n.id):"text"===n.type&&await g(a,o,n.text))}catch(e){console.error("Event handling error:",e),await s.f.replyMessage(a,"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З")}}async function m(e,t,a){try{let r;await s.f.replyMessage(e,"р╕Бр╕│р╕ер╕▒р╕Зр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕нр╕кр╕▒р╕Бр╕Др╕гр╕╣р╣И...");let i=await s.f.downloadImage(a),l=i.toString("base64"),c=`${t}_${Date.now()}.jpg`,u=await o.T.uploadImage(i,c),p=await n.c.analyzeReceipt(l),m=await o.T.saveReceipt(t,u,p.total_amount,p.date||new Date().toISOString().split("T")[0]);p.items&&p.items.length>0&&await o.T.saveItems(m.id,p.items);let g=(r=`тЬЕ р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з!

`,p.store_name&&(r+=`ЁЯПк р╕гр╣Йр╕▓р╕Щ: ${p.store_name}
`),p.date&&(r+=`ЁЯУЕ р╕зр╕▒р╕Щр╕Чр╕╡р╣И: ${p.date}
`),r+=`ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: ${p.total_amount?.toLocaleString()||"р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕"} р╕Ър╕▓р╕Ч

`,p.items&&p.items.length>0&&(r+=`ЁЯУЭ р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕┤р╕Щр╕Др╣Йр╕▓:
`,p.items.forEach(e=>{r+=`тАв ${e.name} - ${e.price?.toLocaleString()} р╕Ър╕▓р╕Ч
`})),r+=`
ЁЯТб р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Бр╕ер╣Йр╕з р╕Юр╕┤р╕бр╕Юр╣М "р╕кр╕гр╕╕р╕Ы" р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╕зр╕▒р╕Щр╕Щр╕╡р╣Й`);await s.f.pushMessage(t,g)}catch(e){console.error("Image processing error:",e),await s.f.pushMessage(t,"р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╣Др╕Фр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣Ир╣Гр╕лр╣Йр╕Кр╕▒р╕Фр╕Вр╕╢р╣Йр╕Щ")}}async function g(e,t,a){let r=a.toLowerCase().trim();if(r.includes("р╕кр╕гр╕╕р╕Ы")||r.includes("summary")){let a=new Date().toISOString().split("T")[0],r=await o.T.getDailySummary(t,a);if(0===r.length){await s.f.replyMessage(e,"р╕зр╕▒р╕Щр╕Щр╕╡р╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И");return}let n=function(e){let t=e.reduce((e,t)=>e+parseFloat(t.total_amount||0),0);return{date:new Date().toLocaleDateString("th-TH"),receiptCount:e.length,totalAmount:t}}(r),i=s.f.createSummaryMessage(n);await s.f.replyMessage(e,i)}else if(r.includes("р╣Ар╕Фр╕╖р╕нр╕Щ")||r.includes("month")){let a=new Date,r=await o.T.getMonthlySummary(t,a.getFullYear(),a.getMonth()+1);if(0===r.length){await s.f.replyMessage(e,"р╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И");return}let n=function(e){let t=e.reduce((e,t)=>e+parseFloat(t.total_amount||0),0),a=e.reduce((e,t)=>e+(t.items?.length||0),0);return`ЁЯУК р╕кр╕гр╕╕р╕Ыр╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й

ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: ${t.toLocaleString()} р╕Ър╕▓р╕Ч
ЁЯУЛ р╕Ир╕│р╕Щр╕зр╕Щр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕И: ${e.length} р╣Гр╕Ъ
ЁЯЫНя╕П р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г: ${a} р╕гр╕▓р╕вр╕Бр╕▓р╕г`}(r);await s.f.replyMessage(e,n)}else await s.f.replyMessage(e,'р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╕гр╕▒р╕Ъ! \uD83D\uDCF1\n\nр╕кр╣Ир╕Зр╕гр╕╣р╕Ыр╣Гр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕бр╕▓р╣Гр╕лр╣Йр╕Ьр╕бр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Др╕Фр╣Йр╣Ар╕ер╕в\n\nр╕лр╕гр╕╖р╕нр╕Юр╕┤р╕бр╕Юр╣М:\nтАв "р╕кр╕гр╕╕р╕Ы" - р╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╕зр╕▒р╕Щр╕Щр╕╡р╣Й\nтАв "р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕кр╕гр╕╕р╕Ыр╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й')}[s,n]=c.then?(await c)():c,r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=525);module.exports=a})();